<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hawk Central ‚Äì Campus Events</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --gold: #F5C518; --gold-dark: #D4A900; --black: #111111;
      --white: #FFFFFF; --gray-bg: #F3F3F3; --gray-light: #E8E8E8;
      --gray-text: #666666; --card-radius: 16px;
    }
    body { font-family: 'DM Sans', sans-serif; background: var(--gray-bg); color: var(--black); min-height: 100vh; }

    nav { background: var(--black); display: flex; align-items: center; padding: 0 32px; height: 70px; position: sticky; top: 0; z-index: 100; gap: 16px; }
    .nav-brand { display: flex; align-items: center; gap: 12px; text-decoration: none; margin-right: auto; }
    .nav-logo { width: 44px; height: 44px; background: var(--gold); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--black); }
    .nav-title span:first-child { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--gold); letter-spacing: 1px; line-height: 1; display: block; }
    .nav-title span:last-child { font-size: 11px; color: #888; display: block; }
    .nav-link { color: var(--gold); text-decoration: none; font-size: 14px; font-weight: 600; padding: 8px 16px; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 6px; }
    .nav-link:hover { background: rgba(245,197,24,0.1); }
    .nav-link.active { background: var(--gold); color: var(--black); }
    .nav-badge { background: var(--black); color: var(--gold); border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .btn-outline { border: 2px solid var(--gold); color: var(--gold); background: transparent; padding: 7px 18px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
    .btn-outline:hover { background: var(--gold); color: var(--black); }
    .btn-gold { background: var(--gold); color: var(--black); border: none; padding: 9px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; transition: background 0.2s; font-family: 'DM Sans', sans-serif; }
    .btn-gold:hover { background: var(--gold-dark); }

    .search-section { background: var(--white); padding: 28px 32px 0; border-bottom: 1px solid var(--gray-light); }
    .search-wrap { max-width: 860px; margin: 0 auto 24px; position: relative; }
    .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 18px; }
    #searchInput { width: 100%; padding: 16px 20px 16px 50px; border: 2px solid var(--gray-light); border-radius: 50px; font-size: 15px; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.2s; color: var(--black); }
    #searchInput:focus { border-color: var(--gold); }
    #searchInput::placeholder { color: #aaa; }

    .filter-bar { max-width: 860px; margin: 0 auto; display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding-bottom: 1px; }
    .filter-bar::-webkit-scrollbar { display: none; }
    .filter-pill { padding: 10px 24px; border-radius: 50px; border: 2px solid var(--gray-light); background: var(--white); font-size: 14px; font-weight: 600; color: #555; cursor: pointer; white-space: nowrap; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
    .filter-pill:hover { border-color: var(--gold); color: var(--black); }
    .filter-pill.active { background: var(--gold); border-color: var(--gold); color: var(--black); }

    .main { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }
    .results-label { font-size: 14px; color: var(--gray-text); margin-bottom: 20px; }

    .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
    .event-card { background: var(--white); border-radius: var(--card-radius); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.2s, box-shadow 0.2s; animation: fadeUp 0.4s ease both; }
    .event-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
    @keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }

    .card-banner { height: 160px; background: linear-gradient(135deg, #F5C518 0%, #E8A800 100%); display: flex; align-items: center; justify-content: center; position: relative; font-size: 56px; }
    .card-category-tag { position: absolute; top: 12px; left: 12px; background: var(--black); color: var(--white); font-size: 10px; font-weight: 700; letter-spacing: 1px; padding: 5px 10px; border-radius: 20px; text-transform: uppercase; }
    .card-body { padding: 16px 18px 18px; }
    .card-title { font-size: 16px; font-weight: 700; color: var(--black); margin-bottom: 8px; line-height: 1.3; }
    .card-description { font-size: 13px; color: var(--gray-text); margin-bottom: 12px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-meta { display: flex; flex-direction: column; gap: 5px; margin-bottom: 14px; }
    .card-meta-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-text); }
    .card-meta-row .icon { font-size: 13px; color: var(--gold-dark); flex-shrink: 0; }
    .card-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--gray-light); padding-top: 12px; }
    .rsvp-count { font-size: 13px; color: var(--gray-text); }

    .btn-rsvp { background: var(--gold); color: var(--black); border: none; padding: 8px 18px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; transition: background 0.2s; font-family: 'DM Sans', sans-serif; }
    .btn-rsvp:hover { background: var(--gold-dark); }
    .btn-rsvp.rsvped { background: #e8f5e9; color: #2e7d32; cursor: default; }

    .owner-actions { display: flex; gap: 6px; }
    .btn-edit { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; background: #e3f0ff; color: #1565c0; transition: background 0.2s; }
    .btn-edit:hover { background: #bbdefb; }
    .btn-delete { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; background: #ffeaea; color: #c62828; transition: background 0.2s; }
    .btn-delete:hover { background: #ffcdd2; }

    .required-star { color: #e53935; margin-left: 2px; }
    .form-hint { font-size: 11px; color: #aaa; margin-top: 3px; }
    .empty-state { text-align: center; padding: 64px 24px; color: var(--gray-text); }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state h3 { font-size: 18px; font-weight: 700; color: var(--black); margin-bottom: 8px; }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--white); border-radius: 20px; padding: 32px; width: 100%; max-width: 480px; animation: modalIn 0.25s ease; max-height: 90vh; overflow-y: auto; }
    @keyframes modalIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
    .modal h2 { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 1px; margin-bottom: 6px; }
    .modal > p { color: var(--gray-text); font-size: 14px; margin-bottom: 20px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: var(--black); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 11px 14px; border: 2px solid var(--gray-light); border-radius: 10px; font-size: 14px; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.2s; color: var(--black); }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--gold); }
    .form-group input.error, .form-group select.error, .form-group textarea.error { border-color: #e53935; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-actions { display: flex; gap: 10px; margin-top: 12px; }
    .btn-cancel { flex: 1; padding: 11px; border: 2px solid var(--gray-light); background: transparent; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: background 0.2s; }
    .btn-cancel:hover { background: var(--gray-bg); }
    .btn-submit { flex: 2; padding: 11px; background: var(--gold); border: none; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: background 0.2s; }
    .btn-submit:hover { background: var(--gold-dark); }
    .modal-close { float: right; background: none; border: none; font-size: 22px; cursor: pointer; color: #aaa; line-height: 1; margin-top: -4px; }

    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--black); color: var(--white); padding: 14px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; display: none; z-index: 300; }
    .toast.show { display: block; }
  </style>
</head>
<body>

<nav>
  <a class="nav-brand" href="index.html">
    <div class="nav-logo">H</div>
    <div class="nav-title"><span>HAWK CENTRAL</span><span>Campus Events</span></div>
  </a>
  <a href="index.html" class="nav-link active">Events</a>
  <a href="dashboard.html" class="nav-link">My RSVPs <span class="nav-badge" id="rsvpBadge">0</span></a>
  <a href="dashboard.html" class="nav-link">Profile</a>
  <div id="authButtons" style="display:flex; gap:8px;">
    <button class="btn-outline" onclick="openModal('loginModal')">Log In</button>
    <button class="btn-gold" onclick="openModal('signupModal')">Sign Up</button>
  </div>
  <div id="userMenu" style="display:none; align-items:center; gap:12px;">
    <span style="color:#888; font-size:13px;">Welcome, <strong id="userFirstName" style="color:var(--gold)"></strong></span>
    <button class="btn-outline" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="search-section">
  <div class="search-wrap">
    <span class="search-icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Search events by title, location, or description..." oninput="handleSearch()"/>
  </div>
  <div class="filter-bar">
    <button class="filter-pill active" data-category="all" onclick="setFilter(this)">All Events</button>
    <button class="filter-pill" data-category="Academic" onclick="setFilter(this)">Academic</button>
    <button class="filter-pill" data-category="Social" onclick="setFilter(this)">Social</button>
    <button class="filter-pill" data-category="Sports" onclick="setFilter(this)">Sports</button>
    <button class="filter-pill" data-category="Clubs" onclick="setFilter(this)">Clubs</button>
    <button class="filter-pill" data-category="Career" onclick="setFilter(this)">Career</button>
    <button class="filter-pill" data-category="Arts" onclick="setFilter(this)">Arts</button>
  </div>
</div>

<main class="main">
  <p class="results-label" id="resultsLabel">Loading events...</p>
  <div class="event-grid" id="eventGrid">
    <div style="text-align:center; padding:48px; grid-column:1/-1; font-size:24px;">‚è≥ Loading...</div>
  </div>
</main>

<button id="addEventBtn" onclick="openModal('eventModal')"
  style="display:none; position:fixed; bottom:28px; right:28px; background:var(--gold);
         border:none; border-radius:50px; padding:14px 24px; font-size:15px; font-weight:700;
         cursor:pointer; font-family:'DM Sans',sans-serif; box-shadow:0 4px 16px rgba(0,0,0,0.2); z-index:99;">
  + Add Event
</button>

<!-- LOGIN -->
<div class="modal-overlay" id="loginModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('loginModal')">‚úï</button>
    <h2>Welcome Back</h2>
    <p>Log in to your Hawk Central account</p>
    <div class="form-group"><label>Email <span class="required-star">*</span></label><input type="email" id="loginEmail" placeholder="you@hawk.edu"/></div>
    <div class="form-group"><label>Password <span class="required-star">*</span></label><input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('loginModal')">Cancel</button>
      <button class="btn-submit" onclick="handleLogin()">Log In</button>
    </div>
    <p style="text-align:center; margin-top:14px; font-size:13px;">Don't have an account? <a href="#" onclick="switchModal('loginModal','signupModal')" style="color:var(--gold-dark);font-weight:600;">Sign up</a></p>
    <p style="text-align:center; margin-top:8px; font-size:13px;"><a href="forgot-password.html" style="color:#aaa;">Forgot password?</a></p>
  </div>
</div>

<!-- SIGNUP -->
<div class="modal-overlay" id="signupModal">
  <div class="modal" style="max-width:520px;">
    <button class="modal-close" onclick="closeModal('signupModal')">‚úï</button>
    <h2>Join Hawk Central</h2>
    <p>Fields marked <span class="required-star">*</span> are required</p>
    <div class="form-row">
      <div class="form-group"><label>First Name <span class="required-star">*</span></label><input type="text" id="signupFirst" placeholder="First"/></div>
      <div class="form-group"><label>Last Name <span class="required-star">*</span></label><input type="text" id="signupLast" placeholder="Last"/></div>
    </div>
    <div class="form-group"><label>Email <span class="required-star">*</span></label><input type="email" id="signupEmail" placeholder="you@hawk.edu"/></div>
    <div class="form-group"><label>Password <span class="required-star">*</span></label><input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    <div class="form-row">
      <div class="form-group"><label>Student ID</label><input type="text" id="signupStudentId" placeholder="S12345678"/></div>
      <div class="form-group"><label>Grad Year</label><input type="number" id="signupGradYear" placeholder="2027"/></div>
    </div>
    <div class="form-group"><label>Major</label><input type="text" id="signupMajor" placeholder="e.g. Computer Science"/></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('signupModal')">Cancel</button>
      <button class="btn-submit" onclick="handleSignup()">Create Account</button>
    </div>
    <p style="text-align:center; margin-top:14px; font-size:13px;">Already have an account? <a href="#" onclick="switchModal('signupModal','loginModal')" style="color:var(--gold-dark);font-weight:600;">Log in</a></p>
  </div>
</div>

<!-- CREATE / EDIT EVENT -->
<div class="modal-overlay" id="eventModal">
  <div class="modal" style="max-width:540px;">
    <button class="modal-close" onclick="closeModal('eventModal')">‚úï</button>
    <h2 id="eventModalTitle">Add New Event</h2>
    <p id="eventModalSubtitle">Fields marked <span class="required-star">*</span> are required</p>
    <div class="form-group"><label>Event Title <span class="required-star">*</span></label><input type="text" id="evTitle" placeholder="e.g. Spring Career Fair 2026"/></div>
    <div class="form-group"><label>Description <span class="required-star">*</span></label><textarea id="evDescription" rows="3" placeholder="What's this event about?"></textarea></div>
    <div class="form-row">
      <div class="form-group"><label>Date <span class="required-star">*</span></label><input type="date" id="evDate"/></div>
      <div class="form-group"><label>Start Time <span class="required-star">*</span></label><input type="time" id="evStartTime"/></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Category <span class="required-star">*</span></label><select id="evCategory"><option value="">Select category...</option></select></div>
      <div class="form-group"><label>Location <span class="required-star">*</span></label><select id="evLocation"><option value="">Select location...</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Organizer Name <span class="required-star">*</span></label><input type="text" id="evOrganizer" placeholder="Club or department"/></div>
      <div class="form-group">
        <label>Max Capacity</label>
        <input type="number" id="evCapacity" placeholder="Leave blank = unlimited"/>
        <div class="form-hint">Optional ‚Äî leave blank for unlimited</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('eventModal')">Cancel</button>
      <button class="btn-submit" onclick="handleSaveEvent()">Save Event</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const API = 'http://localhost:3000';
  let currentUser = JSON.parse(localStorage.getItem('hc_user') || 'null');
  let allEvents = [];
  let activeCategory = 'all';
  let searchTerm = '';
  let editingEventId = null;
  let myRsvpedEvents = JSON.parse(localStorage.getItem('hc_rsvps') || '[]');

  window.addEventListener('DOMContentLoaded', () => {
    updateAuthUI();
    loadEvents();
    loadCategories();
    loadLocations();
    updateRsvpBadge();
  });

  function updateAuthUI() {
    if (currentUser) {
      document.getElementById('authButtons').style.display = 'none';
      document.getElementById('userMenu').style.display = 'flex';
      document.getElementById('userFirstName').textContent = currentUser.first_name;
      document.getElementById('addEventBtn').style.display = 'block';
    } else {
      document.getElementById('authButtons').style.display = 'flex';
      document.getElementById('userMenu').style.display = 'none';
      document.getElementById('addEventBtn').style.display = 'none';
    }
  }

  function updateRsvpBadge() {
    document.getElementById('rsvpBadge').textContent = myRsvpedEvents.length;
  }

  async function loadEvents() {
    try {
      const res = await fetch(`${API}/events`);
      allEvents = await res.json();
      allEvents.sort((a, b) => new Date(a.event_date) - new Date(b.event_date));
      renderEvents();
    } catch {
      document.getElementById('eventGrid').innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="icon">‚ö†Ô∏è</div><h3>Could not load events</h3><p>Make sure the server is running on localhost:3000</p></div>`;
    }
  }

  function renderEvents() {
    const grid = document.getElementById('eventGrid');
    const label = document.getElementById('resultsLabel');
    let filtered = [...allEvents];

    if (activeCategory !== 'all') {
      filtered = filtered.filter(e => e.category_name && e.category_name.toLowerCase().includes(activeCategory.toLowerCase()));
    }
    if (searchTerm) {
      const s = searchTerm.toLowerCase();
      filtered = filtered.filter(e =>
        (e.title && e.title.toLowerCase().includes(s)) ||
        (e.description && e.description.toLowerCase().includes(s)) ||
        (e.location_name && e.location_name.toLowerCase().includes(s))
      );
    }

    label.textContent = `Showing ${filtered.length} upcoming event${filtered.length !== 1 ? 's' : ''}`;

    if (filtered.length === 0) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="icon">üì≠</div><h3>No events found</h3><p>Try a different search or filter</p></div>`;
      return;
    }

    grid.innerHTML = filtered.map((e, i) => {
      const isOwner = currentUser && currentUser.user_id === e.created_by;
      const isAdmin = currentUser && currentUser.role === 'super_admin';
      const alreadyRsvped = myRsvpedEvents.includes(e.event_id);
      return `
        <div class="event-card" style="animation-delay:${i*0.05}s">
          <div class="card-banner">
            <span class="card-category-tag">${e.category_name || 'Event'}</span>
            ${getCategoryEmoji(e.category_name)}
          </div>
          <div class="card-body">
            <div class="card-title">${e.title}</div>
            ${e.description ? `<div class="card-description">${e.description}</div>` : ''}
            <div class="card-meta">
              <div class="card-meta-row"><span class="icon">üìÖ</span><span>${formatDate(e.event_date, e.start_time)}</span></div>
              <div class="card-meta-row"><span class="icon">üìç</span><span>${e.location_name || e.building_name || 'TBD'}</span></div>
              ${e.max_capacity ? `<div class="card-meta-row"><span class="icon">üë•</span><span>Capacity: ${e.max_capacity}</span></div>` : ''}
            </div>
            <div class="card-footer">
              <span class="rsvp-count">‚úÖ ${e.rsvp_count || 0} going</span>
              ${(isOwner || isAdmin) ? `
                <div class="owner-actions">
                  <button class="btn-edit" onclick="openEditEvent(${e.event_id})">‚úèÔ∏è</button>
                  <button class="btn-delete" onclick="deleteEvent(${e.event_id})">üóëÔ∏è</button>
                </div>` : `
                <button class="btn-rsvp ${alreadyRsvped ? 'rsvped' : ''}" id="rsvpBtn_${e.event_id}" onclick="handleRSVP(${e.event_id}, this)">
                  ${alreadyRsvped ? '‚úì Going' : 'RSVP'}
                </button>`}
            </div>
          </div>
        </div>`;
    }).join('');
  }

  function setFilter(btn) {
    document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    activeCategory = btn.dataset.category;
    renderEvents();
  }

  function handleSearch() {
    searchTerm = document.getElementById('searchInput').value;
    renderEvents();
  }

  async function handleRSVP(eventId, btn) {
    if (!currentUser) {
      showToast('‚ö†Ô∏è Please log in to RSVP');
      openModal('loginModal');
      return;
    }
    if (myRsvpedEvents.includes(eventId)) {
      showToast('You already RSVP\'d to this event!');
      return;
    }
    try {
      const res = await fetch(`${API}/rsvp`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ event_id: eventId, user_id: currentUser.user_id, rsvp_status: 'attending' })
      });
      if (!res.ok) throw new Error(await res.text());
      myRsvpedEvents.push(eventId);
      localStorage.setItem('hc_rsvps', JSON.stringify(myRsvpedEvents));
      updateRsvpBadge();
      btn.textContent = '‚úì Going';
      btn.classList.add('rsvped');
      const ev = allEvents.find(e => e.event_id === eventId);
      if (ev) ev.rsvp_count = (parseInt(ev.rsvp_count) || 0) + 1;
      showToast('‚úÖ RSVP confirmed!');
    } catch (err) {
      showToast('‚ùå RSVP failed: ' + err.message);
    }
  }

  async function loadCategories() {
    try {
      const res = await fetch(`${API}/categories`);
      const cats = await res.json();
      const sel = document.getElementById('evCategory');
      cats.forEach(c => { const o = document.createElement('option'); o.value = c.category_id; o.textContent = c.category_name; sel.appendChild(o); });
    } catch {}
  }

  async function loadLocations() {
    try {
      const res = await fetch(`${API}/locations`);
      const locs = await res.json();
      const sel = document.getElementById('evLocation');
      locs.forEach(l => { const o = document.createElement('option'); o.value = l.location_id; o.textContent = l.location_name; sel.appendChild(o); });
    } catch {}
  }

  function validateEventForm() {
    let valid = true;
    document.querySelectorAll('#eventModal input, #eventModal select, #eventModal textarea').forEach(el => el.classList.remove('error'));
    [['evTitle','Title'],['evDescription','Description'],['evDate','Date'],['evStartTime','Start Time'],['evOrganizer','Organizer']].forEach(([id]) => {
      const el = document.getElementById(id);
      if (!el.value.trim()) { el.classList.add('error'); valid = false; }
    });
    if (!document.getElementById('evCategory').value) { document.getElementById('evCategory').classList.add('error'); valid = false; }
    if (!document.getElementById('evLocation').value) { document.getElementById('evLocation').classList.add('error'); valid = false; }
    if (!valid) showToast('‚ö†Ô∏è Please fill in all required fields (marked with *)');
    return valid;
  }

  async function handleSaveEvent() {
    if (!currentUser) return;
    if (!validateEventForm()) return;
    const cap = document.getElementById('evCapacity').value;
    const payload = {
      title: document.getElementById('evTitle').value.trim(),
      description: document.getElementById('evDescription').value.trim(),
      event_date: document.getElementById('evDate').value,
      start_time: document.getElementById('evStartTime').value,
      category_id: parseInt(document.getElementById('evCategory').value),
      location_id: parseInt(document.getElementById('evLocation').value),
      organizer_name: document.getElementById('evOrganizer').value.trim(),
      max_capacity: cap ? parseInt(cap) : null,
      created_by: currentUser.user_id
    };
    try {
      let res;
      if (editingEventId) {
        res = await fetch(`${API}/events/${editingEventId}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({...payload, user_id: currentUser.user_id, user_role: currentUser.role}) });
        showToast('‚úÖ Event updated!');
      } else {
        res = await fetch(`${API}/events`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        showToast('‚úÖ Event created!');
      }
      if (!res.ok) { showToast('‚ùå ' + await res.text()); return; }
      closeModal('eventModal');
      await loadEvents();
    } catch { showToast('‚ùå Could not save event'); }
  }

  function openEditEvent(eventId) {
    const e = allEvents.find(ev => ev.event_id === eventId);
    if (!e) return;
    editingEventId = eventId;
    document.getElementById('eventModalTitle').textContent = 'Edit Event';
    document.getElementById('evTitle').value = e.title || '';
    document.getElementById('evDescription').value = e.description || '';
    document.getElementById('evDate').value = e.event_date ? e.event_date.slice(0,10) : '';
    document.getElementById('evStartTime').value = e.start_time || '';
    document.getElementById('evCategory').value = e.category_id || '';
    document.getElementById('evLocation').value = e.location_id || '';
    document.getElementById('evOrganizer').value = e.organizer_name || '';
    document.getElementById('evCapacity').value = e.max_capacity || '';
    openModal('eventModal');
  }

  async function deleteEvent(eventId) {
    if (!confirm('Delete this event? This cannot be undone.')) return;
    try {
      await fetch(`${API}/events/${eventId}`, { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({user_id: currentUser.user_id, user_role: currentUser.role}) });
      showToast('üóëÔ∏è Event deleted');
      await loadEvents();
    } catch { showToast('‚ùå Could not delete event'); }
  }

  async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!email || !password) { showToast('‚ö†Ô∏è Please enter email and password'); return; }
    try {
      const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({email, password}) });
      if (!res.ok) { showToast('‚ùå ' + await res.text()); return; }
      currentUser = await res.json();
      localStorage.setItem('hc_user', JSON.stringify(currentUser));
      closeModal('loginModal');
      updateAuthUI();
      renderEvents();
      showToast(`üëã Welcome back, ${currentUser.first_name}!`);
    } catch { showToast('‚ùå Login failed ‚Äî is the server running?'); }
  }

  async function handleSignup() {
    const first = document.getElementById('signupFirst').value.trim();
    const last = document.getElementById('signupLast').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    if (!first || !last || !email || !password) { showToast('‚ö†Ô∏è Please fill in all required fields'); return; }
    try {
      const res = await fetch(`${API}/signup`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({email, password, first_name: first, last_name: last, student_id: document.getElementById('signupStudentId').value, graduation_year: document.getElementById('signupGradYear').value || null, major: document.getElementById('signupMajor').value}) });
      if (!res.ok) { showToast('‚ùå ' + await res.text()); return; }
      currentUser = await res.json();
      localStorage.setItem('hc_user', JSON.stringify(currentUser));
      closeModal('signupModal');
      updateAuthUI();
      showToast(`üéâ Welcome to Hawk Central, ${currentUser.first_name}!`);
    } catch { showToast('‚ùå Signup failed'); }
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem('hc_user');
    localStorage.removeItem('hc_rsvps');
    myRsvpedEvents = [];
    updateAuthUI();
    updateRsvpBadge();
    renderEvents();
    showToast('üëã Logged out');
  }

  function openModal(id) {
    if (id === 'eventModal' && !editingEventId) {
      document.getElementById('eventModalTitle').textContent = 'Add New Event';
      ['evTitle','evDescription','evDate','evStartTime','evOrganizer','evCapacity'].forEach(f => document.getElementById(f).value = '');
      document.getElementById('evCategory').value = '';
      document.getElementById('evLocation').value = '';
    }
    document.getElementById(id).classList.add('open');
  }

  function closeModal(id) {
    editingEventId = null;
    document.getElementById(id).classList.remove('open');
    document.querySelectorAll('#eventModal input, #eventModal select, #eventModal textarea').forEach(el => el.classList.remove('error'));
  }

  function switchModal(from, to) { closeModal(from); openModal(to); }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3500);
  }

  function formatDate(dateStr, timeStr) {
    if (!dateStr) return 'TBD';
    const d = new Date(dateStr + 'T12:00:00');
    const date = d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' });
    if (!timeStr) return date;
    const [h, m] = timeStr.split(':');
    const hour = parseInt(h);
    return `${date} ‚Ä¢ ${hour % 12 || 12}:${m} ${hour >= 12 ? 'PM' : 'AM'}`;
  }

  function getCategoryEmoji(cat) {
    if (!cat) return 'üìÖ';
    const c = cat.toLowerCase();
    if (c.includes('sport')) return 'üèÄ';
    if (c.includes('academic') || c.includes('study')) return 'üìö';
    if (c.includes('social')) return 'üéâ';
    if (c.includes('club')) return 'üèõÔ∏è';
    if (c.includes('career')) return 'üíº';
    if (c.includes('art') || c.includes('culture')) return 'üé®';
    return 'üìÖ';
  }

  document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); }));
</script>
</body>
</html>
